#include "app_config.h"
#include <fcntl.h>
#include <unistd.h>
#ifdef __HCRTOS__
#include <kernel/vfs.h>
#include <kernel/io.h>
#include <kernel/completion.h>
#endif
#include <stdio.h>
#include <getopt.h>
#include <malloc.h>

#include <sys/ioctl.h>
#include <sys/types.h>
#include <hcuapi/common.h>
#include <hcuapi/pq.h>

#include "factory_setting.h"
#include "setup.h"
// MAX_NUM_PQ_CFG
#define MAX_NUM_PQ_CFG   3

/* Note: this struct is defined in  #include <hcuapi/pq.h>. so here marked
// Struct - Item
struct pq_settings{
	// info
	char* name;
	// 0x00
	bool pq_en;
	bool igam_en;
	bool mtx_en;
	bool gntf_en;
	bool slmt_en;
	bool gam_en;
	// 0x10
	bool linear_region_enable;
	unsigned int linear_region;
	unsigned int linear_slope;
	// 0x20
	int mtx_c00;
	int mtx_c01;
	// 0x24
	int mtx_c02;
	int mtx_c10;
	// 0x28
	int mtx_c11;
	int mtx_c12;
	// 0x2c
	int mtx_c20;
	int mtx_c21;
	// 0x30
	int mtx_c22;
	// 0x34
	unsigned int gntf_gain_r;
	unsigned int gntf_gain_g;
	unsigned int gntf_gain_b;
	// 0x38
	int gntf_offset_r;
	int gntf_offset_g;
	int gntf_offset_b;
	// 0x40
	bool slmt_neg_en;
	bool slmt_max_en;
	unsigned int slmt_neg_oftgn;
	unsigned int slmt_slope;
	int slmt_delta;
	// 0x60
	int invgamma_lut_r[67];
	int invgamma_lut_g[67];
	int invgamma_lut_b[67];
	// 0x70
	int gamma_lut_r[131];
	int gamma_lut_g[131];
	int gamma_lut_b[131];
};
*/
// Struct - Set
struct pq_param{
	// VERSION
	char* tools_version;
	char* data_version;
	// COMMON
	bool overwrite;
	// COLOR DEVICE
	float dev_r_x;
	float dev_r_y;
	float dev_g_x;
	float dev_g_y;
	float dev_b_x;
	float dev_b_y;
	float dev_w_x;
	float dev_w_y;
	// COLOR TEMPERATURES
	struct pq_settings pq_design_reg[MAX_NUM_PQ_CFG]; 
};

// Values
static struct pq_param pqReg = {
	// VERSION
	"1.0.0", "20221102152409",
	// COMMON
	true,
	// COLOR DEVICE
	0.640000, 0.330000, 0.300000, 0.600000, 0.150000, 0.060000, 0.312700, 0.329000,
	// COLOR TEMPERATURES
	{
		{
			// info
			"standard",
			// 0x00
			true, true, true, true, true, true,
			// 0x10
			true, 21, 228,
			// 0x20
			1038, 30,
			// 0x24
			0, -1,
			// 0x28
			1010, 0,
			// 0x2c
			1, 3,
			// 0x30
			1056,
			// 0x34
			128, 128, 128,
			// 0x38
			0, 0, 0,
			// 0x40
			true, true, 4, 8, 29,
			// 0x60
			{ -3, 0, 4, 7, 11, 14, 18, 21, 25, 30, 35, 40, 46, 52, 58, 65, 72, 80, 88, 97, 106, 115, 125, 136, 147, 158, 170, 182, 195, 208, 222, 236, 250, 266, 281, 297, 314, 331, 349, 367, 385, 405, 424, 444, 465, 486, 508, 530, 553, 576, 600, 625, 650, 675, 701, 728, 755, 782, 810, 839, 868, 898, 929, 959, 991, 1023, 1056 },
			{ -3, 0, 4, 7, 11, 14, 18, 21, 25, 30, 35, 40, 46, 52, 58, 65, 72, 80, 88, 97, 106, 115, 125, 136, 147, 158, 170, 182, 195, 208, 222, 236, 250, 266, 281, 297, 314, 331, 349, 367, 385, 405, 424, 444, 465, 486, 508, 530, 553, 576, 600, 625, 650, 675, 701, 728, 755, 782, 810, 839, 868, 898, 929, 959, 991, 1023, 1056 },
			{ -3, 0, 4, 7, 11, 14, 18, 21, 25, 30, 35, 40, 46, 52, 58, 65, 72, 80, 88, 97, 106, 115, 125, 136, 147, 158, 170, 182, 195, 208, 222, 236, 250, 266, 281, 297, 314, 331, 349, 367, 385, 405, 424, 444, 465, 486, 508, 530, 553, 576, 600, 625, 650, 675, 701, 728, 755, 782, 810, 839, 868, 898, 929, 959, 991, 1023, 1056 },
			// 0x70
			{ -23, 0, 23, 32, 40, 46, 51, 56, 60, 65, 68, 72, 76, 79, 82, 85, 88, 91, 94, 96, 99, 102, 104, 107, 109, 111, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 143, 145, 147, 149, 150, 152, 154, 155, 157, 158, 160, 162, 163, 165, 166, 168, 169, 171, 172, 174, 175, 177, 178, 180, 181, 182, 184, 185, 186, 188, 189, 190, 192, 193, 194, 196, 197, 198, 200, 201, 202, 203, 205, 206, 207, 208, 209, 211, 212, 213, 214, 215, 217, 218, 219, 220, 221, 222, 223, 225, 226, 227, 228, 229, 230, 231, 232, 233, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256 },
			{ -23, 0, 23, 32, 40, 46, 51, 56, 60, 65, 68, 72, 76, 79, 82, 85, 88, 91, 94, 96, 99, 102, 104, 107, 109, 111, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 143, 145, 147, 149, 150, 152, 154, 155, 157, 158, 160, 162, 163, 165, 166, 168, 169, 171, 172, 174, 175, 177, 178, 180, 181, 182, 184, 185, 186, 188, 189, 190, 192, 193, 194, 196, 197, 198, 200, 201, 202, 203, 205, 206, 207, 208, 209, 211, 212, 213, 214, 215, 217, 218, 219, 220, 221, 222, 223, 225, 226, 227, 228, 229, 230, 231, 232, 233, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256 },
			{ -23, 0, 23, 32, 40, 46, 51, 56, 60, 65, 68, 72, 76, 79, 82, 85, 88, 91, 94, 96, 99, 102, 104, 107, 109, 111, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 143, 145, 147, 149, 150, 152, 154, 155, 157, 158, 160, 162, 163, 165, 166, 168, 169, 171, 172, 174, 175, 177, 178, 180, 181, 182, 184, 185, 186, 188, 189, 190, 192, 193, 194, 196, 197, 198, 200, 201, 202, 203, 205, 206, 207, 208, 209, 211, 212, 213, 214, 215, 217, 218, 219, 220, 221, 222, 223, 225, 226, 227, 228, 229, 230, 231, 232, 233, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256 }
		},
		{
			// info
			"cold",
			// 0x00
			true, true, true, true, true, true,
			// 0x10
			true, 21, 228,
			// 0x20
			984, -42,
			// 0x24
			-14, 2,
			// 0x28
			1022, -6,
			// 0x2c
			8, 29,
			// 0x30
			1338,
			// 0x34
			128, 128, 128,
			// 0x38
			0, 0, 0,
			// 0x40
			true, true, 4, 8, 29,
			// 0x60
			{ -3, 0, 4, 7, 11, 14, 18, 21, 25, 30, 35, 40, 46, 52, 58, 65, 72, 80, 88, 97, 106, 115, 125, 136, 147, 158, 170, 182, 195, 208, 222, 236, 250, 266, 281, 297, 314, 331, 349, 367, 385, 405, 424, 444, 465, 486, 508, 530, 553, 576, 600, 625, 650, 675, 701, 728, 755, 782, 810, 839, 868, 898, 929, 959, 991, 1023, 1056 },
			{ -3, 0, 4, 7, 11, 14, 18, 21, 25, 30, 35, 40, 46, 52, 58, 65, 72, 80, 88, 97, 106, 115, 125, 136, 147, 158, 170, 182, 195, 208, 222, 236, 250, 266, 281, 297, 314, 331, 349, 367, 385, 405, 424, 444, 465, 486, 508, 530, 553, 576, 600, 625, 650, 675, 701, 728, 755, 782, 810, 839, 868, 898, 929, 959, 991, 1023, 1056 },
			{ -3, 0, 4, 7, 11, 14, 18, 21, 25, 30, 35, 40, 46, 52, 58, 65, 72, 80, 88, 97, 106, 115, 125, 136, 147, 158, 170, 182, 195, 208, 222, 236, 250, 266, 281, 297, 314, 331, 349, 367, 385, 405, 424, 444, 465, 486, 508, 530, 553, 576, 600, 625, 650, 675, 701, 728, 755, 782, 810, 839, 868, 898, 929, 959, 991, 1023, 1056 },
			// 0x70
			{ -23, 0, 23, 32, 40, 46, 51, 56, 60, 65, 68, 72, 76, 79, 82, 85, 88, 91, 94, 96, 99, 102, 104, 107, 109, 111, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 143, 145, 147, 149, 150, 152, 154, 155, 157, 158, 160, 162, 163, 165, 166, 168, 169, 171, 172, 174, 175, 177, 178, 180, 181, 182, 184, 185, 186, 188, 189, 190, 192, 193, 194, 196, 197, 198, 200, 201, 202, 203, 205, 206, 207, 208, 209, 211, 212, 213, 214, 215, 217, 218, 219, 220, 221, 222, 223, 225, 226, 227, 228, 229, 230, 231, 232, 233, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256 },
			{ -23, 0, 23, 32, 40, 46, 51, 56, 60, 65, 68, 72, 76, 79, 82, 85, 88, 91, 94, 96, 99, 102, 104, 107, 109, 111, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 143, 145, 147, 149, 150, 152, 154, 155, 157, 158, 160, 162, 163, 165, 166, 168, 169, 171, 172, 174, 175, 177, 178, 180, 181, 182, 184, 185, 186, 188, 189, 190, 192, 193, 194, 196, 197, 198, 200, 201, 202, 203, 205, 206, 207, 208, 209, 211, 212, 213, 214, 215, 217, 218, 219, 220, 221, 222, 223, 225, 226, 227, 228, 229, 230, 231, 232, 233, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256 },
			{ -23, 0, 23, 32, 40, 46, 51, 56, 60, 65, 68, 72, 76, 79, 82, 85, 88, 91, 94, 96, 99, 102, 104, 107, 109, 111, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 143, 145, 147, 149, 150, 152, 154, 155, 157, 158, 160, 162, 163, 165, 166, 168, 169, 171, 172, 174, 175, 177, 178, 180, 181, 182, 184, 185, 186, 188, 189, 190, 192, 193, 194, 196, 197, 198, 200, 201, 202, 203, 205, 206, 207, 208, 209, 211, 212, 213, 214, 215, 217, 218, 219, 220, 221, 222, 223, 225, 226, 227, 228, 229, 230, 231, 232, 233, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256 }
		},
		{
			// info
			"warm",
			// 0x00
			true, true, true, true, true, true,
			// 0x10
			true, 21, 228,
			// 0x20
			1228, 336,
			// 0x24
			37, -15,
			// 0x28
			921, 9,
			// 0x2c
			-14, -46,
			// 0x30
			476,
			// 0x34
			128, 128, 128,
			// 0x38
			0, 0, 0,
			// 0x40
			true, true, 4, 8, 29,
			// 0x60
			{ -3, 0, 4, 7, 11, 14, 18, 21, 25, 30, 35, 40, 46, 52, 58, 65, 72, 80, 88, 97, 106, 115, 125, 136, 147, 158, 170, 182, 195, 208, 222, 236, 250, 266, 281, 297, 314, 331, 349, 367, 385, 405, 424, 444, 465, 486, 508, 530, 553, 576, 600, 625, 650, 675, 701, 728, 755, 782, 810, 839, 868, 898, 929, 959, 991, 1023, 1056 },
			{ -3, 0, 4, 7, 11, 14, 18, 21, 25, 30, 35, 40, 46, 52, 58, 65, 72, 80, 88, 97, 106, 115, 125, 136, 147, 158, 170, 182, 195, 208, 222, 236, 250, 266, 281, 297, 314, 331, 349, 367, 385, 405, 424, 444, 465, 486, 508, 530, 553, 576, 600, 625, 650, 675, 701, 728, 755, 782, 810, 839, 868, 898, 929, 959, 991, 1023, 1056 },
			{ -3, 0, 4, 7, 11, 14, 18, 21, 25, 30, 35, 40, 46, 52, 58, 65, 72, 80, 88, 97, 106, 115, 125, 136, 147, 158, 170, 182, 195, 208, 222, 236, 250, 266, 281, 297, 314, 331, 349, 367, 385, 405, 424, 444, 465, 486, 508, 530, 553, 576, 600, 625, 650, 675, 701, 728, 755, 782, 810, 839, 868, 898, 929, 959, 991, 1023, 1056 },
			// 0x70
			{ -23, 0, 23, 32, 40, 46, 51, 56, 60, 65, 68, 72, 76, 79, 82, 85, 88, 91, 94, 96, 99, 102, 104, 107, 109, 111, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 143, 145, 147, 149, 150, 152, 154, 155, 157, 158, 160, 162, 163, 165, 166, 168, 169, 171, 172, 174, 175, 177, 178, 180, 181, 182, 184, 185, 186, 188, 189, 190, 192, 193, 194, 196, 197, 198, 200, 201, 202, 203, 205, 206, 207, 208, 209, 211, 212, 213, 214, 215, 217, 218, 219, 220, 221, 222, 223, 225, 226, 227, 228, 229, 230, 231, 232, 233, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256 },
			{ -23, 0, 23, 32, 40, 46, 51, 56, 60, 65, 68, 72, 76, 79, 82, 85, 88, 91, 94, 96, 99, 102, 104, 107, 109, 111, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 143, 145, 147, 149, 150, 152, 154, 155, 157, 158, 160, 162, 163, 165, 166, 168, 169, 171, 172, 174, 175, 177, 178, 180, 181, 182, 184, 185, 186, 188, 189, 190, 192, 193, 194, 196, 197, 198, 200, 201, 202, 203, 205, 206, 207, 208, 209, 211, 212, 213, 214, 215, 217, 218, 219, 220, 221, 222, 223, 225, 226, 227, 228, 229, 230, 231, 232, 233, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256 },
			{ -23, 0, 23, 32, 40, 46, 51, 56, 60, 65, 68, 72, 76, 79, 82, 85, 88, 91, 94, 96, 99, 102, 104, 107, 109, 111, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 143, 145, 147, 149, 150, 152, 154, 155, 157, 158, 160, 162, 163, 165, 166, 168, 169, 171, 172, 174, 175, 177, 178, 180, 181, 182, 184, 185, 186, 188, 189, 190, 192, 193, 194, 196, 197, 198, 200, 201, 202, 203, 205, 206, 207, 208, 209, 211, 212, 213, 214, 215, 217, 218, 219, 220, 221, 222, 223, 225, 226, 227, 228, 229, 230, 231, 232, 233, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256 }
		}
	}
};


int set_color_temperature(int mode)
{
    int pq_fd = -1;
    
    pq_fd = open("/dev/pq" , O_WRONLY);
    if(pq_fd < 0)
    {
        return -1;
    }
    printf("pq_start\n");
    switch(mode)
    {
        case COLOR_TEMP_STANDARD:
            ioctl(pq_fd , PQ_SET_PARAM,&pqReg.pq_design_reg[0]);
            break;
        case COLOR_TEMP_WARM:
            ioctl(pq_fd , PQ_SET_PARAM,&pqReg.pq_design_reg[2]);
            break;
         case COLOR_TEMP_COLD:
            ioctl(pq_fd , PQ_SET_PARAM,&pqReg.pq_design_reg[1]);
            break;            
        default:
            break;
    }
	projector_set_some_sys_param(P_COLOR_TEMP, mode);
	projector_sys_param_save();
    ioctl(pq_fd , PQ_START);
    close(pq_fd);

    return 0;
}



